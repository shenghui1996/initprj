(function(f){var e={getSerializedTags:function(){var k=[];f(this).find("li.tagItem").each(function(l,m){k.push(f(m).text())});return k.join(",")},getTags:function(){var k=[];f(this).find("li.tagItem").each(function(l,m){k.push(f(m).text())});return k},version:function(){return"1.3.0"}};f.fn.tagHandler=function(k){if(typeof(k)=="object"||typeof(k)=="undefined"){var l=f.extend({},f.fn.tagHandler.defaults,k);c(f(this),l);return this.each(function(){if(!f(this).is("ul")){return true}var p=this;var o=f(p);if(!p.id){var q=new Date();p.id=q.getTime()}o.wrap('<div class="'+l.className+'" />');o.addClass(l.className+"Container");if(l.allowEdit){o.html('<li class="tagInput"><input class="tagInputField" type="text" placeholder="请输入感兴趣标签" /></li>')}var m=o.find(".tagInputField");var n=[];n.availableTags=[];n.originalTags=[];n.assignedTags=[];if(l.updateURL!==""){if(!l.autoUpdate){f("<div />").attr({id:p.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){j(n,l,p.id)}).appendTo(o.parent())}f("<div />").attr({id:p.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(o.parent())}if(l.autocomplete&&typeof(f.fn.autocomplete)=="function"&&l.initLoad){f(m).autocomplete({source:n.availableTags,select:function(t,v){var r=f(this);if(!d(f.trim(v.item.value),n.assignedTags)){if(l.maxTags>0&&n.assignedTags.length>=l.maxTags){alert("Maximum tags allowed: "+l.maxTags)}else{var s=f.trim(v.item.value);var u=1;if(typeof(l.onAdd)=="function"){u=l.onAdd.call(this,s)}if(u||typeof(u)=="undefined"){n=b(this,s,n,l.sortTags);if(l.updateURL!==""&&l.autoUpdate){j(n,l,p.id)}f(m).autocomplete("option","source",n.availableTags);if(typeof(l.afterAdd)=="function"){l.afterAdd.call(this,s)}}}r.focus()}r.val("");return false},minLength:l.minChars})}else{if(l.autocomplete&&typeof(f.fn.autocomplete)=="function"){f(m).autocomplete({source:function(t,r){l.getData[l.queryname]=t.term;var s=f.getJSON(l.getURL,l.getData,function(v,u,w){r(v.availableTags)})},select:function(t,v){var r=f(this);if(!d(f.trim(v.item.value),n.assignedTags)){if(l.maxTags>0&&n.assignedTags.length>=l.maxTags){alert("Maximum tags allowed: "+l.maxTags)}else{var s=f.trim(v.item.value);var u=1;if(typeof(l.onAdd)=="function"){l.onAdd.call(this,s)}if(u||typeof(u)=="undefined"){n=b(this,f.trim(v.item.value),n,l.sortTags);if(l.updateURL!==""&&l.autoUpdate){j(n,l,p.id)}if(typeof(l.afterAdd)=="function"){l.afterAdd.call(this,s)}}}r.focus()}r.val("");return false},minLength:l.minChars})}}if(l.getURL!==""&&l.initLoad){f.ajax({url:l.getURL,cache:false,data:l.getData,dataType:"json",success:function(r,t,s){if(r.availableTags.length){n.availableTags=r.availableTags.slice();n.originalTags=n.availableTags.slice()}if(l.sortTags){n=h(n)}if(r.assignedTags.length){n.assignedTags=r.assignedTags.slice();if(l.sortTags){n=h(n)}n=a(l,n,m,p)}if(l.autocomplete&&typeof(f.fn.autocomplete)=="function"&&l.allowEdit){f(m).autocomplete("option","source",n.availableTags)}},error:function(t,s,r){c(t,s,r);alert(l.msgError)}})}else{if(l.getURL!==""){n.assignedTags=l.assignedTags.slice();if(l.sortTags){n=h(n)}n=a(l,n,m,p)}else{if(l.availableTags.length){n.availableTags=l.availableTags.slice();n.originalTags=n.availableTags.slice()}if(l.sortTags){n=h(n)}if(l.assignedTags.length){n.assignedTags=l.assignedTags.slice();if(l.sortTags){n=h(n)}n=a(l,n,m,p)}if(l.autocomplete&&typeof(f.fn.autocomplete)=="function"&&l.allowEdit&&l.initLoad){f(m).autocomplete("option","source",n.availableTags)}}}if(l.allowEdit){o.delegate("li.tagItem","click",function(){var r=f(this);var s=1;if(typeof(l.onDelete)=="function"){s=l.onDelete.call(this,f.trim(r.text()))}if(s){n=i(r,n,l.sortTags);if(l.updateURL!==""&&l.autoUpdate){j(n,l,p.id)}}if(typeof(l.afterDelete)=="function"){l.afterDelete.call(this,f.trim(r.text()))}if(l.autocomplete&&typeof(f.fn.autocomplete)=="function"&&l.initLoad){f(m).autocomplete("option","source",n.availableTags)}});f(m).keypress(function(u){var r=f(this);if(u.which===13||u.which===44||u.which===l.delimiter.charCodeAt(0)){u.preventDefault();if(r.val()!==""&&!d(f.trim(r.val()),n.assignedTags)){if(!l.allowAdd&&!d(f.trim(r.val()),n.availableTags)){alert(l.msgNoNewTag);return}if(l.maxTags>0&&n.assignedTags.length>=l.maxTags){alert("Maximum tags allowed: "+l.maxTags)}else{var s=f.trim(r.val());var t=1;if(typeof(l.onAdd)=="function"){t=l.onAdd.call(this,s)}if(t||typeof(t)=="undefined"){n=b(this,s,n,l.sorttags);if(l.updateURL!==""&&l.autoUpdate){j(n,l,p.id)}if(l.autocomplete&&typeof(f.fn.autocomplete)=="function"&&l.initload){f(m).autocomplete("option","source",n.availableTags)}if(typeof(l.afterAdd)=="function"){l.afterAdd.call(this,s)}}}r.val("");r.focus()}}});f(m).keydown(function(t){var s=f(this);if(t.which===8&&s.val()===""){var r=o.find(".tagItem:last").text();if(typeof(l.onDelete)=="function"){l.onDelete.call(this,f.trim(r))}n=i(o.find(".tagItem:last"),n,l.sortTags);if(l.updateURL!==""&&l.autoUpdate){j(n,l,p.id)}if(typeof(l.afterDelete)=="function"){l.afterDelete.call(this,f.trim(r))}if(l.autocomplete&&typeof(f.fn.autocomplete)=="function"&&l.initLoad){f(m).autocomplete("option","source",n.availableTags)}s.focus()}});f(m).focus(function(){if(f(m).val()===""&&l.autocomplete&&typeof(f.fn.autocomplete)=="function"&&l.initLoad){f(m).autocomplete("search","")}});o.click(function(){f(m).focus()})}this.getTags=function(){return n.assignedTags};return 1})}else{if(typeof(k)=="string"&&e[k]){return e[k].apply(this,Array.prototype.slice.call(arguments,1))}}};f.fn.tagHandler.defaults={allowEdit:true,allowAdd:true,assignedTags:[],autocomplete:false,autoUpdate:false,availableTags:[],className:"tagHandler",debug:false,delimiter:"",getData:{},getURL:"",initLoad:true,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",onAdd:{},onDelete:{},afterAdd:{},afterDelete:{},queryname:"q",sortTags:true,updateData:{},updateURL:""};function d(m,l){var k=false;jQuery.each(l,function(n,o){if(o===m){k=true;return false}});return k}function g(l,k){jQuery.each(k,function(m,n){if(n===l){k.splice(m,1)}});return k}function b(k,n,l,m){l.assignedTags.push(n);l.availableTags=g(n,l.availableTags);f("<li />").addClass("tagItem").text(n).insertBefore(f(k).parent());if(m){l=h(l)}return l}function i(k,l,m){var n=f(k).text();l.assignedTags=g(n,l.assignedTags);if(d(n,l.originalTags)){l.availableTags.push(n)}f(k).remove();if(m){l=h(l)}return l}function h(k){k.availableTags=k.availableTags.sort();k.assignedTags=k.assignedTags.sort();k.originalTags=k.originalTags.sort();return k}function j(l,n,m){var k={tags:l.assignedTags};f.extend(k,n.updateData);f.ajax({type:"POST",url:n.updateURL,cache:false,data:k,dataType:"json",beforeSend:function(){if(f("#"+m+"_save").length){f("#"+m+"_save").fadeOut(200,function(){f("#"+m+"_loader").fadeIn(200)})}else{f("#"+m+"_loader").fadeIn(200)}},complete:function(){f("#"+m+"_loader").fadeOut(200,function(){if(f("#"+m+"_save").length){f("#"+m+"_save").fadeIn(200)}})}})}function a(m,l,k,n){f(l.assignedTags).each(function(o,p){if(m.allowEdit){f("<li />").addClass("tagItem").text(p).insertBefore(f(k).parent())}else{f("<li />").addClass("tagItem").css("cursor","default").text(p).appendTo(f(n))}l.availableTags=g(p,l.availableTags)});return l}function c(l,k){if(k.debug&&window.console&&window.console.log){window.console.log(l);window.console.log(k);window.console.log(f.fn.tagHandler.defaults)}}})(jQuery);